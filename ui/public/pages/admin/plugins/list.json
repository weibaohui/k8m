{
    "type": "page",
    "title": "插件管理",
    "body": [
        {
            "type": "collapse",
            "header": "插件状态流转说明",
            "collapsed": true,
            "body": [
                {
                    "type": "tpl",
                    "tpl": "<div style='padding: 10px; line-height: 1.8;'>\n  <strong>插件状态流转顺序：</strong>\n  <span class='label label-info'>已发现</span> →\n  <span class='label label-default'>已安装</span> →\n  <span class='label label-primary'>已启用</span> →\n  <span class='label label-success'>运行中</span> ↔\n  <span class='label label-warning'>已停止</span> →\n  <span class='label label-danger'>已禁用</span> →\n  <span class='label label-danger'>卸载</span>\n  <br><br>\n  <strong>各状态说明：</strong>\n  <ul style='margin: 10px 0; padding-left: 20px;'>\n    <li><strong>已发现</strong>：系统扫描到插件但未安装</li>\n    <li><strong>已安装</strong>：插件已安装到数据库，但未启用</li>\n    <li><strong>已启用</strong>：插件已启用，但未启动运行</li>\n    <li><strong>运行中</strong>：插件正在运行，可以停止</li>\n    <li><strong>已停止</strong>：插件已停止运行，可以启动或禁用</li>\n    <li><strong>已禁用</strong>：插件已禁用，可以启用或卸载</li>\n  </ul>\n</div>"
                }
            ]
        },
        {
            "type": "crud",
            "id": "pluginCRUD",
            "name": "pluginCRUD",
            "perPage": 1000,
            "autoFillHeight": true,
            "autoGenerateFilter": {
                "columnsNum": 4,
                "showBtnToolbar": false
            },
            "headerToolbar": [
                "reload",
                "bulkActions"
            ],
            "api": "get:/admin/plugin/list",
            "columns": [
                {
                    "type": "operation",
                    "label": "操作",
                    "width": "240px",
                    "buttons": [
                        {
                            "type": "button",
                            "icon": "fas fa-info-circle text-info",
                            "actionType": "drawer",
                            "label": "详情",
                            "drawer": {
                                "closeOnEsc": true,
                                "closeOnOutside": true,
                                "size": "lg",
                                "title": "${title} 详情 （ESC 关闭）",
                                "body": [
                                    {
                                        "type": "static",
                                        "name": "version",
                                        "label": "标识",
                                        "tpl": "${name} ${title} (${status})"
                                    },
                                    {
                                        "type": "static",
                                        "name": "version",
                                        "label": "版本",
                                        "tpl": "插件：${version}，数据库：${dbVersion|default:-}"
                                    },
                                    {
                                        "type": "static",
                                        "name": "description",
                                        "label": "描述"
                                    },
                                    {
                                        "type": "panel",
                                        "title": "数据库表",
                                        "body": [
                                            {
                                                "type": "static",
                                                "tpl": "${tables|join:', '}"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "panel",
                                        "title": "菜单列表",
                                        "body": [
                                            {
                                                "type": "table",
                                                "source": "${menus}",
                                                "columns": [
                                                    {
                                                        "name": "menu",
                                                        "label": "菜单",
                                                        "type": "tpl",
                                                        "tpl": "${icon ? `<i class='${icon}'></i> ` : ''}${title}"
                                                    },
                                                    {
                                                        "name": "eventType",
                                                        "label": "点击",
                                                        "type": "tpl",
                                                        "tpl": "${customEvent?customEvent:url}"
                                                    },
                                                    {
                                                        "name": "order",
                                                        "label": "排序"
                                                    },
                                                    {
                                                        "name": "show",
                                                        "label": "显示条件"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "type": "panel",
                                        "title": "路由列表",
                                        "body": [
                                            {
                                                "type": "tabs",
                                                "tabs": [
                                                    {
                                                        "title": "集群 API",
                                                        "body": {
                                                            "type": "table",
                                                            "source": "${routes.cluster || []}",
                                                            "columns": [
                                                                {
                                                                    "name": "method",
                                                                    "label": "方法",
                                                                    "width": "100px"
                                                                },
                                                                {
                                                                    "name": "path",
                                                                    "label": "路径"
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "title": "管理 API",
                                                        "body": {
                                                            "type": "table",
                                                            "source": "${routes.mgm || []}",
                                                            "columns": [
                                                                {
                                                                    "name": "method",
                                                                    "label": "方法",
                                                                    "width": "100px"
                                                                },
                                                                {
                                                                    "name": "path",
                                                                    "label": "路径"
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "title": "管理员 API",
                                                        "body": {
                                                            "type": "table",
                                                            "source": "${routes.admin || []}",
                                                            "columns": [
                                                                {
                                                                    "name": "method",
                                                                    "label": "方法",
                                                                    "width": "100px"
                                                                },
                                                                {
                                                                    "name": "path",
                                                                    "label": "路径"
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-check-double text-primary",
                            "actionType": "ajax",
                            "label": "安装",
                            "visibleOn": "this.status == '已发现'",
                            "confirmText": "确认安装该插件？",
                            "api": "post:/admin/plugin/install/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-play-circle text-success",
                            "actionType": "ajax",
                            "label": "启用",
                            "visibleOn": "this.status == '已安装' || this.status == '已禁用'",
                            "confirmText": "确认启用该插件？",
                            "api": "post:/admin/plugin/enable/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-play text-success",
                            "actionType": "ajax",
                            "label": "启动",
                            "visibleOn": "this.status == '已启用' || this.status == '已停止'",
                            "confirmText": "确认启动该插件？",
                            "api": "post:/admin/plugin/start/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-stop text-danger",
                            "actionType": "ajax",
                            "label": "停止",
                            "visibleOn": "this.status == '运行中'",
                            "confirmText": "确认停止该插件？",
                            "api": "post:/admin/plugin/stop/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-stop-circle text-danger",
                            "actionType": "ajax",
                            "label": "禁用",
                            "visibleOn": "this.status == '已停止'",
                            "confirmText": "确认禁用该插件？",
                            "api": "post:/admin/plugin/disable/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-trash text-danger",
                            "actionType": "ajax",
                            "label": "卸载删除数据",
                            "visibleOn": "this.status == '已禁用'",
                            "confirmText": "确认卸载该插件？该插件下的数据会被删除。",
                            "api": "post:/admin/plugin/uninstall/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-trash-restore text-info",
                            "actionType": "ajax",
                            "label": "卸载保留数据",
                            "visibleOn": "this.status == '已禁用'",
                            "confirmText": "确认卸载该插件但保留数据？",
                            "api": "post:/admin/plugin/uninstall-keep-data/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-level-up-alt text-info",
                            "actionType": "ajax",
                            "label": "升级",
                            "visibleOn": "this.canUpgrade && this.status != '已发现'",
                            "confirmText": "确认升级该插件？",
                            "api": "post:/admin/plugin/upgrade/${name}"
                        },
                        {
                            "type": "button",
                            "icon": "fas fa-clock text-info",
                            "visibleOn": "this.cronCount && this.cronCount >0",
                            "actionType": "drawer",
                            "label": "定时任务",
                            "drawer": {
                                "closeOnEsc": true,
                                "closeOnOutside": true,
                                "size": "lg",
                                "title": "${title} 任务详情（ESC 关闭）",
                                "body": [
                                    {
                                        "type": "crud",
                                        "api": "get:/admin/plugin/cron/${name}",
                                        "quickSaveItemApi": "/admin/plugin/cron/name/${name}/spec/${spec|base64Encode}/enabled/${registered}",
                                        "syncLocation": false,
                                        "loadDataOnce": false,
                                        "headerToolbar": [
                                            "reload"
                                        ],
                                        "columns": [
                                            {
                                                "name": "spec",
                                                "label": "Cron表达式"
                                            },
                                            {
                                                "name": "registered",
                                                "label": "生效",
                                                "type": "switch",
                                                "onText": "开启",
                                                "offText": "关闭",
                                                "quickEdit": {
                                                    "mode": "inline",
                                                    "type": "switch",
                                                    "saveImmediately": true,
                                                    "resetOnFailed": true
                                                }
                                            },
                                            {
                                                "name": "next",
                                                "label": "下次执行"
                                            },
                                            {
                                                "name": "prev",
                                                "label": "上次执行"
                                            },
                                            {
                                                "name": "running",
                                                "label": "运行中",
                                                "type": "mapping",
                                                "map": {
                                                    "true": "<span class='label label-success'>是</span>",
                                                    "false": "<span class='label label-default'>否</span>"
                                                }
                                            },
                                            {
                                                "type": "operation",
                                                "label": "操作",
                                                "buttons": [
                                                    {
                                                        "type": "button",
                                                        "icon": "fas fa-bolt text-primary",
                                                        "label": "执行一次",
                                                        "actionType": "ajax",
                                                        "api": "post:/admin/plugin/cron/${name}/run_once?spec=${spec}"
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "title",
                    "label": "名称",
                    "type": "tpl",
                    "tpl": "${title}(${name})",
                    "width": "240px"
                },
                {
                    "type": "tpl",
                    "name": "version",
                    "width": "140px",
                    "label": "版本",
                    "tpl": "<span class='label label-default'>插&nbsp;&nbsp;&nbsp;&nbsp;件</span> ${version} <br><span class='label label-info'>数据库</span> ${dbVersion|default:-}"
                },
                {
                    "name": "status",
                    "label": "状态",
                    "type": "mapping",
                    "map": {
                        "已发现": "<span class='label label-info'>已发现</span>",
                        "已安装": "<span class='label label-default'>已安装</span>",
                        "已启用": "<span class='label label-primary'>已启用</span>",
                        "运行中": "<span class='label label-success'>运行中</span>",
                        "已停止": "<span class='label label-warning'>已停止</span>",
                        "已禁用": "<span class='label label-danger'>已禁用</span>",
                        "未知": "<span class='label label-danger'>未知</span>"
                    }
                },
                {
                    "name": "count",
                    "label": "构成",
                    "width": "180px",
                    "type": "tpl",
                    "tpl": "菜单:${menuCount|default:0}<br>库表:${tableCount|default:0}<br>定时任务:${cronCount|default:0}"
                },
                {
                    "name": "dependencies",
                    "label": "运行依赖<br><span class='text-gray-500 text-xs'>缺失无法运行</span>",
                    "type": "tpl",
                    "tpl": "${dependencies|join:', '}",
                    "width": "160px"
                },
                {
                    "name": "runAfter",
                    "label": "启动依赖<br><span class='text-gray-500 text-xs'>在此之后启动</span>",
                    "type": "tpl",
                    "tpl": "${runAfter|join:', '}",
                    "width": "160px"
                },
                {
                    "name": "description",
                    "label": "描述",
                    "width": "300px"
                }
            ],
            "bulkActions": []
        }
    ]
}