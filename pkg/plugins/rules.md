# k8m 插件（Feature Module）架构定义 v1.0

> 本文档用于**先行固化 k8m 插件体系的抽象、边界与约束**，在此基础上再开展代码实现。
>
> 目标不是“灵活”，而是：**可控、可裁剪、可维护、可规模化扩展**。

---

## 1. 设计目标

k8m 插件体系用于解决以下问题：

- 功能模块数量持续增长，核心复杂度过高
- 不同部署环境对功能裁剪需求不同
- 新功能希望低侵入、可独立开发、可独立启停
- 前后端、权限、数据模型需要强一致

因此插件体系的设计目标是：

1. **一个插件 = 一个完整功能单元（Feature Module）**
2. 插件可安装 / 启用 / 禁用 / 卸载
3. 插件能力边界清晰、显式声明
4. 插件之间无隐式依赖
5. 插件描述以 Go 代码为主，编译期加载
6. 前端统一使用 AMIS JSON 作为渲染描述

---

## 2. 插件基本定义

### 2.1 插件定位

在 k8m 中：

> **插件不是 Hook，也不是轻量扩展，而是“可插拔子系统”。**

插件通常具备以下能力中的若干项：

- 菜单入口
- 前端页面（AMIS JSON）
- 后端 API
- 权限定义（RBAC）
- SQL 表结构或数据模型
- 初始化 / 清理逻辑

---

## 3. 插件生命周期模型

插件具备完整、显式的生命周期：

```
Discover → Install → Enable → Disable → Uninstall
```

### 3.1 Discover（发现）

- 插件在编译期通过 Go 注册
- 系统启动时完成插件元信息加载

### 3.2 Install（安装）

安装阶段负责**不可逆或重成本操作**：

- 创建数据库表
- 初始化基础数据
- 注册权限模型

> Install 只执行一次，具有幂等性要求。

### 3.3 Enable（启用）

启用阶段负责**运行期能力暴露**：

- 菜单可见
- API 可访问
- 前端 AMIS JSON 可加载

### 3.4 Disable（禁用）

禁用阶段负责**能力收敛**：

- 菜单隐藏
- API 不可访问
- 前端资源返回 404

> 禁用不删除数据、不删除权限定义。

### 3.5 Uninstall（卸载）

卸载阶段负责**彻底移除插件痕迹**（可选）：

- 删除数据库表（如允许）
- 删除初始化数据
- 清理插件注册信息

---

## 4. 插件描述方式（核心约束）

### 4.1 描述语言约束

- **除 AMIS JSON 外，所有插件描述必须使用 Go 代码**
- 禁止使用 YAML / JSON 描述插件结构

原因：

- 编译期校验
- IDE 自动补全
- 可重构
- 可审计
- 避免运行期解析错误

---

## 5. 插件目录结构规范

```text
modules/
 └── <plugin-name>/
     ├── plugin.go        插件元信息（必选）
     ├── menu.go          菜单定义（可选）
     ├── permission.go    权限定义（可选）
     ├── api.go           后端 API（可选）
     ├── sql.go           表结构 / SQL（可选）
     ├── init.go          插件注册入口（必选）
     └── frontend/
          ├── page.json   AMIS 页面（可选）
          └── *.json
```

---

## 6. 插件元信息定义

插件必须声明基础元信息，用于：

- 插件管理
- 版本控制
- 依赖判断

插件元信息包含：

- 插件唯一名称
- 展示名称
- 版本号
- 描述信息

> 插件名称在系统内必须唯一。

---

## 7. 菜单模型定义

插件可声明 0 个或多个菜单。

菜单用于：

- 前端导航
- 权限绑定
- 页面入口定位

菜单模型应至少包含：

- ID
- 标题
- 路径（指向 AMIS 页面）
- 所需权限

菜单仅在插件 **Enable** 后可见。

---

## 8. 前端模型（AMIS）定义

### 8.1 前端技术约束

- 插件前端 **只允许 AMIS JSON**
- 禁止插件引入 React / Vue 代码
- 禁止插件执行任意 JS 逻辑

### 8.2 前端加载方式

- 前端通过统一 API 获取 AMIS JSON
- 插件启用前，请求返回 404

AMIS JSON 仅用于描述界面结构，不参与权限决策。

---

## 9. 权限模型（RBAC）

插件可定义自己的权限集合。

权限用于：

- 菜单显示控制
- API 访问控制
- 前端按钮可见性控制

权限具备：

- 全局唯一名称
- 展示名称

权限在插件 Install 阶段注册，在 Disable 阶段不删除。

---

## 10. 后端 API 规范

插件后端 API 必须满足：

- 路径以 `/api/plugins/<plugin-name>/` 开头
- API 在 Enable 阶段注册
- API 在 Disable 阶段不可访问

插件 API 不允许绕过统一鉴权与审计体系。

---

## 11. SQL / 数据模型规范

插件可声明：

- 独立数据库表
- 数据初始化逻辑

要求：

- 表名前缀必须包含插件名
- SQL 定义具备幂等性
- 不允许修改其他插件或核心表结构

---

## 12. 插件之间的关系约束

- 插件之间 **不得直接相互调用内部实现**
- 允许通过核心提供的公共能力交互
- 插件依赖关系必须显式声明

---

## 13. 插件管理原则（重要）

- 插件不是热插拔组件
- 插件启停属于**运维级操作**
- 稳定性优先于动态性

---

## 14. 反设计原则（明确禁止）

以下行为在插件体系中**明确禁止**：

- 插件直接修改核心代码
- 插件私自注册全局路由
- 插件返回任意前端代码
- 插件绕过 RBAC 鉴权
- 插件跨模块访问数据库表

---

> **本定义文档作为 k8m 插件体系的唯一权威规范，在 v1.0 范围内保持向后兼容。**

